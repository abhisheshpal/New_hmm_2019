---
init_cmd: |
  #exec /bin/bash
  set -o pipefail
  function export_default () {
    var_name="$1"
    var_default="$2"
    eval $var_name="${!var_name:-$var_default}"
    export $var_name
    echo "  $0 -> $var_name=${!var_name}"
  }

  # source ROS
  source "/opt/ros/kinetic/setup.bash"
  # search for VPN tun device:
  default_iface=`route -n | grep "^10.8" | tr -s " " |  cut -f8 -d" " || echo lo`
  default_ip=`ip addr show dev "$default_iface" | grep "inet " | sed 's@ *inet \([0-9\.]*\).*@\1@' || echo 127.0.0.1`
  
  # load robot-specific config file
  if [ -r "$HOME/.rasberryrc" ]; then echo "*** loading $HOME/.rasberryrc" ; source "$HOME/.rasberryrc"; fi
  export_default BASE_CONFIG_DIR `readlink -f . || echo .`
  export_default ROBOT_NAME `hostname | tr "-" "_" | tr "." "_"`
  #export_default SCENARIO_NAME "sim_riseholme"
  export_default SCENARIO_NAME "default"
  # load robot-specific config file
  if [ -r "$BASE_CONFIG_DIR/$ROBOT_NAME.sh" ]; then echo "*** loading $BASE_CONFIG_DIR/$ROBOT_NAME.sh" ; source "$BASE_CONFIG_DIR/$ROBOT_NAME.sh"; fi
  # load scenario-specific config file
  if [ -r "$BASE_CONFIG_DIR/$SCENARIO_NAME.sh" ]; then echo "*** loading $BASE_CONFIG_DIR/$SCENARIO_NAME.sh" ; source "$BASE_CONFIG_DIR/$SCENARIO_NAME.sh"; fi  # configure the development workspace (assuming we are in rasberry_bringup/tmule)
  export_default CATKIN_WORKSPACE "`readlink -f ../../../.. || echo $HOME/rasberry_ws`"
  source "$CATKIN_WORKSPACE/devel/setup.bash"
  # set ROS_MASTER to the correct IP
  export_default ROS_MASTER $default_ip
  # set ROS_IP not to the IP that we will connect to remotely
  export_default ROS_IP `ip route get $ROS_MASTER | grep "src" | sed 's/.*src \([0-9\.]*\).*/\1/' || echo $ROS_MASTER`
  # set ROS_HOSTNAME to the ROS_IP to avoid configuring /etc/hosts for anyone who connects
  export_default ROS_HOSTNAME "$ROS_IP"
  # path where to expect MONGODB
  export_default MONGO_PATH "$HOME/mongodb"
  # the topomap to be used
  export_default TMAP riseholme_bidirectional_sim
  # the gridmap to be used (key in mongodb)
  export_default MAP "$(rospack find rasberry_navigation)/maps/riseholme_sim.yaml"
  export_default NOGOMAP "$(rospack find rasberry_navigation)/maps/riseholme_sim_no_go.yaml"
  # set the ROS_MASTER_URI and ROSBRIDGE
  export ROBOTS_URI="http://$ROS_MASTER:11311/"
  export SERVER_URI="http://$ROS_MASTER:11411/"
  export ROS_MASTER_URI=${ROBOTS_URI}
  export_default ROSBRIDGE_IP "localhost"
  export_default ROSBRIDGE_PORT "9090"
  # sim related
  export_default USE_SIM true
  export_default USE_GUI false
  export_default GAZEBO_WORLD riseholme
  export_default EKF_PUBLISH_TF true
  export_default USE_CARROT false
  export_default USE_IMU false
  export_default USE_OMNI false
  # robot_1
  export ROBOT_NO_1="008"
  export ROBOT_NAME_1=thorvald_001
  export ROBOT_MODEL_1=$(rospack find rasberry_bringup)/config/robot_${ROBOT_NO_1}.yaml
  export ROBOT_MODEL_EXTRAS_1=$(rospack find rasberry_bringup)/urdf/robot_${ROBOT_NO_1}_sensors_corner_hokuyos.xacro
  export ROBOT_POS_X_1=-1.0
  export ROBOT_POS_Y_1=4.0
  export ROBOT_POS_A_1=0.0
  # robot_2
  export ROBOT_NO_2="008"
  export ROBOT_NAME_2=thorvald_002
  export ROBOT_MODEL_2=$(rospack find rasberry_bringup)/config/robot_${ROBOT_NO_2}.yaml
  export ROBOT_MODEL_EXTRAS_2=$(rospack find rasberry_bringup)/urdf/robot_${ROBOT_NO_2}_sensors_corner_hokuyos.xacro 
  export ROBOT_POS_X_2=-0.5
  export ROBOT_POS_Y_2=1.3
  export ROBOT_POS_A_2=0.0
  # mongo
  export ROBOTS_MONGO_PATH=$MONGO_PATH/robots
  export ROBOTS_MONGO_PORT=62345
  export SERVER_MONGO_PATH=$MONGO_PATH/server
  export SERVER_MONGO_PORT=62346
  # DES specific
  export_default MIMIC_CONFIG "$(rospack find rasberry_des)/config/mimic_riseholme_des.yaml"

windows:
- name: inits
  panes:
  - roscore
  - sleep 3; mkdir -p "$ROBOTS_MONGO_PATH" && roslaunch mongodb_store mongodb_store.launch port:=$ROBOTS_MONGO_PORT db_path:=$ROBOTS_MONGO_PATH
  - export ROS_MASTER_URI=${SERVER_URI}; roscore -p 11411
  - sleep 3; export ROS_MASTER_URI=${SERVER_URI}; mkdir -p "$SERVER_MONGO_PATH" && roslaunch mongodb_store mongodb_store.launch port:=$SERVER_MONGO_PORT db_path:=$SERVER_MONGO_PATH
- name: robots
  panes:
  - roslaunch rasberry_bringup gazebo_bringup.launch with_gui:=$USE_GUI world_name:=$GAZEBO_WORLD
  - roslaunch rasberry_bringup robot_bringup_multisim.launch robot_name:=$ROBOT_NAME_1 robot_model:=$ROBOT_MODEL_1 model_extras:=$ROBOT_MODEL_EXTRAS_1 with_teleoperation:=false start_pose_x:=$ROBOT_POS_X_1 start_pose_y:=$ROBOT_POS_Y_1 start_pose_Y:=$ROBOT_POS_A_1
  - roslaunch rasberry_bringup robot_bringup_multisim.launch robot_name:=$ROBOT_NAME_2 robot_model:=$ROBOT_MODEL_2 model_extras:=$ROBOT_MODEL_EXTRAS_2 with_teleoperation:=false start_pose_x:=$ROBOT_POS_X_2 start_pose_y:=$ROBOT_POS_Y_2 start_pose_Y:=$ROBOT_POS_A_2
- name: localisation
  panes:
  - rosrun persistent_topics single_channel_persistent_topics_node _topics:="['/topological_map']" _file_name:="$HOME/.ros/rasberry.ptb"
  - roslaunch rasberry_navigation map_server.launch map:="$MAP" use_no_go_map:=true no_go_map:=$NOGOMAP
  - roslaunch rasberry_navigation rasberry_localisation_multisim_corner_hokuyos.launch use_imu:="$USE_IMU" publish_tf:="$EKF_PUBLISH_TF" robot_name:=$ROBOT_NAME_1 initial_pose_x:=$ROBOT_POS_X_1 initial_pose_y:=$ROBOT_POS_Y_1 initial_pose_a:=$ROBOT_POS_A_1
  - roslaunch rasberry_navigation rasberry_localisation_multisim_corner_hokuyos.launch use_imu:="$USE_IMU" publish_tf:="$EKF_PUBLISH_TF" robot_name:=$ROBOT_NAME_2 initial_pose_x:=$ROBOT_POS_X_2 initial_pose_y:=$ROBOT_POS_Y_2 initial_pose_a:=$ROBOT_POS_A_2
- name: navigation
  panes:
  - roslaunch rasberry_move_base move_base_dwa_multisim_corner_hokuyos.launch use_carrot_planner:=$USE_CARROT robot_name:=$ROBOT_NAME_1 use_omni:=$USE_OMNI
  - roslaunch rasberry_navigation topological_navigation_robot_multisim.launch move_base_reconf_service:=DWAPlannerROS robot_name:=$ROBOT_NAME_1
  - roslaunch rasberry_move_base move_base_dwa_multisim_corner_hokuyos.launch use_carrot_planner:=$USE_CARROT robot_name:=$ROBOT_NAME_2 use_omni:=$USE_OMNI
  - roslaunch rasberry_navigation topological_navigation_robot_multisim.launch move_base_reconf_service:=DWAPlannerROS robot_name:=$ROBOT_NAME_2
- name: rosduct
  panes:
  - export ROS_MASTER_URI=${SERVER_URI}; roslaunch rasberry_coordination coordination.launch
  - sleep 3; export ROS_MASTER_URI=${SERVER_URI}; roslaunch rasberry_navigation topological_map_manager_central.launch map:=$TMAP
  - roslaunch rasberry_coordination robot_websocket_adapter_multisim.launch robot_name:=$ROBOT_NAME_1 rosbridge_ip:=$ROS_MASTER rosbridge_port:=$ROSBRIDGE_PORT
  - roslaunch rasberry_coordination robot_websocket_adapter_multisim.launch robot_name:=$ROBOT_NAME_2 rosbridge_ip:=$ROS_MASTER rosbridge_port:=$ROSBRIDGE_PORT
  - roslaunch rasberry_coordination des_picker_websocket_adapter_multisim.launch rosbridge_ip:=$ROS_MASTER rosbridge_port:=$ROSBRIDGE_PORT
- name: coordination
  panes:
  - export ROS_MASTER_URI=${SERVER_URI}; roscd rasberry_coordination/callarobot; python callarobot.py
  - export ROS_MASTER_URI=${SERVER_URI}; python $(rospack find rasberry_coordination)/callarobot/ws_client.py
  - export ROS_MASTER_URI=${SERVER_URI}; rosrun rasberry_coordination simple_task_executor_node.py $(rospack find rasberry_coordination)/config/map_config_$SCENARIO_NAME.yaml
- name: people_perception
  panes:
  - rostopic pub -r 3 /hedge_pos_a marvelmind_nav/hedge_pos_a -- '1' '0' '12.3' '-3.31' '0.0' '0'
  - rostopic pub -r 3 /hedge_pos_a marvelmind_nav/hedge_pos_a -- '2' '0' '18.0' '5.0' '0.0' '0'
  - export ROS_MASTER_URI=${SERVER_URI}; rosrun rasberry_people_perception simple_marvel_localiser.py
- name: des
  panes:
  - export ROS_MASTER_URI=${SERVER_URI}; echo "rosrun rasberry_des mimic_longpicks.py $MIMIC_CONFIG"
- name: visualisation
  panes:
  - roslaunch rasberry_navigation topological_visualiser_multisim.launch robot_name:=$ROBOT_NAME_1 map:=$TMAP
  - echo "roslaunch rasberry_navigation topological_visualiser_multisim.launch robot_name:=$ROBOT_NAME_2 map:=$TMAP"
  - rviz -d $(rospack find rasberry_bringup)/resources/topological_navigation_multisim.rviz
